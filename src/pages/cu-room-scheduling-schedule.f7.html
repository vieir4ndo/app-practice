<template>
	<div class="page" data-name="cu-room-scheduling-schedule">

		<div class="navbar">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				<!-- Link to go back -->
				<div class="left">
					<a href="/" class="link back">
						<i class="icon icon-back"></i>
						<span class="if-not-md">Voltar</span>
					</a>
				</div>
				<div class="title">Agendamento de Salas</div>
			</div>
		</div>

		<div class="page-content">
			<div id="lottie" class="block row display-flex align-items-center">
				<div id="lottie-text">
					<h2 class="no-margin">Agendar Sala</h2>
				</div>
				<div class="col-60">
					<lottie-player src="../static/lottie/cu-room-scheduling-schedule.json" loop autoplay>
					</lottie-player>
				</div>
			</div>
			<div class="display-flex justify-content-space-around">
				<span class="badge color-primary padding" @click="filterRoomSchedule('begin')">
					<h2 class="display-flex">
						De: <input type="text" readonly="readonly" value="01/08/2022 14:30" data-roomschedulefilter="begin"/>
					</h2>
				</span>
			</div>
			<div class="display-flex justify-content-space-around margin-top">
				<span class="badge color-primary padding" @click="filterRoomSchedule('end')">
					<h2 class="display-flex">
						Até: <input type="text" readonly="readonly" value="01/08/2022 14:30" data-roomschedulefilter="end"/>
					</h2>
				</span>
			</div>
			<div class="list simple-list">
				<ul class="roomScheduling">
					<li class="item-content" @click="openRequestSchedule()">
						<div class="item-inner">
							<div class="item-title-row">
								<div class="item-title">
									<div><b>Sala 404</b></div>
									<span class="badge color-orange">Bloco A</span>
								</div>
							</div>
							<div class="item-text no-wrap">50 Alunos</div>
						</div>
					</li>
					<li class="item-content" @click="openRequestSchedule()">
						<div class="item-inner">
							<div class="item-title-row">
								<div class="item-title">
									<div><b>Sala 403</b></div>
									<span class="badge color-orange">Bloco A</span>
								</div>
							</div>
							<div class="item-text no-wrap">30 Alunos</div>
						</div>
					</li>
				</ul>
			</div>
		</div>

		<div class="fab fab-right-bottom color-orange">
			<a href="#">
				<i class="icon f7-icons if-not-md">plus</i>
				<i class="icon f7-icons if-not-md">xmark</i>
				<i class="icon material-icons md-only">add</i>
				<i class="icon material-icons md-only">close</i>
			</a>
			<div class="fab-buttons fab-buttons-top">
				<a class="fab-label-button" href="/cu/room-scheduling/lessee/">
					<span><i class="icon f7-icons">calendar_badge_plus</i></span>
					<span class="fab-label">Agendamentos</span>
				</a>
				<a class="fab-label-button" href="/cu/room-scheduling/responsible/">
					<span><i class="icon f7-icons">chat_bubble_fill</i></span>
					<span class="fab-label">Solicitações</span>
				</a>
			</div>
		</div>

		<div class="popup" id="cu-room-scheduling-schedule-popup">
			<div class="block no-margin-bottom">
				<a class="link popup-close" href="#">
					<i class="f7-icons">chevron_left</i>Voltar
				</a>
				<div class="display-flex flex-direction-column justify-content-flex-start">
					<div class="block no-margin-bottom">
						<h2>Sala 403 <span class="badge color-orange"><b>Bloco A</b></span></h2>
						<div>Responsável pela Sala: Dênio Duarte</div>
						<hr class="margin-vertical">
					</div>
					<form id="cu-room-schedule">
						<div class="list no-hairlines no-margin">
							<ul>
								<li class="item-content item-input item-input-outline">
									<div class="item-inner">
										<div class="item-title item-floating-label">Data de Início</div>
										<div class="item-input-wrap">
											<input type="text" name="schedule-begin" disabled readonly/>
										</div>
									</div>
								</li>
								<li class="item-content item-input item-input-outline">
									<div class="item-inner">
										<div class="item-title item-floating-label">Data de Fim</div>
										<div class="item-input-wrap">
											<input type="text" name="schedule-end" disabled readonly/>
										</div>
									</div>
								</li>
								{{#if CCR}}
								<li class="item-content item-input item-input-outline">
									<div class="item-inner">
										<div class="item-title item-floating-label">CCR Vinculado</div>
										<div class="item-input-wrap">
											<select name="schedule-ccr">
												<option value=0></option>
												{{#each CCR}}
												<option value="{{this.id}}">{{this.name}}</option>
												{{/each}}
											</select>
										</div>
									</div>
								</li>
								{{/if}}
								<li class="item-content item-input item-input-outline">
									<div class="item-inner">
										<div class="item-title item-floating-label">Observações do Agendamento</div>
										<div class="item-input-wrap">
											<textarea name="schedule-description" id="" cols="30" rows="10"></textarea>
										</div>
									</div>
								</li>
							</ul>
						</div>
						<input type="hidden" name="schedule-room" value="1">
					</form>

					<div class="block">
						<button class="button button-fill color-green margin-top" @click="requestRoomSchedule()">
							Enviar Solicitação
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</template>
<style>
    .roomScheduling .item-content {
        line-height: normal;
        height: 100px;
    }

    /* Striped List */
    .roomScheduling .item-content:nth-child(even) {
        background-color: rgb(230, 230, 230);
    }

    input[data-roomschedulefilter] {
        margin-left: 5px;
        font-weight: bold;
        width: 150px;
    }
</style>
<script>
    export default {
        data: function () {
            return {
                CCR: null,
            }
        },
        on: {
            pageInit: function () {
                this.loadCCRs();
            },
        },
        methods: {
            filterRoomSchedule(filter) {
                let app = this.$app;

                let calendar = app.calendar.create({
                    inputEl: 'input[data-roomschedulefilter="' + filter + '"]',
                    dateFormat: 'dd/mm/yyyy HH::mm',
                    closeOnSelect: true,
                    backdrop: true,
                    timePicker: true,
                    on: {
                        close: function () {
                            console.log('Procurar()')
                        },
                        closed: function () {
                            calendar.destroy();
                        }
                    }
                });

                calendar.open();
            },
            openRequestSchedule() {
                let app = this.$app;

                app.form.fillFromData('#cu-room-schedule', {
                    'schedule-begin': app.$('input[data-roomschedulefilter="begin"]').val(),
                    'schedule-end': app.$('input[data-roomschedulefilter="end"]').val(),
                })

                let popup = app.popup.create({
                    swipeToClose: 'to-bottom',
                    closeByBackdropClick: true,
                    el: app.$$('#cu-room-scheduling-schedule-popup'),
                })
                popup.open();
            },
            requestRoomSchedule() {
                let app = this.$app;
                let formData = app.form.convertToData('#cu-room-schedule');

                app.dialog.preloader("Solicitando...");
                app.api.requestRoomSchedule(formData).then(data => {
                    app.dialog.close();
                    app.popup.close(app.$$('#cu-room-scheduling-schedule-popup'));
                    app.views.main.router.navigate('/cu/room-scheduling/lessee/');
                }).catch(e => {
                    app.dialog.close();
                    app.dialog.alert("Ocorreu um erro inesperado, tente novamente!");
                })
            },
            loadCCRs() {
                let app = this.$app;

                app.api.getCCRs().then(CCR => {
                    this.$setState({
                        CCR: CCR,
                    });
                }).catch(e => {
                    app.dialog.alert("Ocorreu um erro inesperado, tente novamente!");
                });
            }
        }
    }
</script>