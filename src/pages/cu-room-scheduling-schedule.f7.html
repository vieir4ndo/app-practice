<template>
	<div class="page" data-name="cu-room-scheduling-schedule">

		<div class="navbar">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				<!-- Link to go back -->
				<div class="left">
					<a href="/" class="link back">
						<i class="icon icon-back"></i>
						<span class="if-not-md">Voltar</span>
					</a>
				</div>
				<div class="title">Agendamento de Salas</div>
			</div>
		</div>

		<div class="page-content">
			<div id="lottie" class="block row display-flex align-items-center">
				<div id="lottie-text">
					<h2 class="no-margin">Agendar Sala</h2>
				</div>
				<div class="col-60">
					<lottie-player src="../static/lottie/cu-room-scheduling-schedule.json" loop autoplay>
					</lottie-player>
				</div>
			</div>
			<div class="display-flex justify-content-space-around">
				<span class="badge color-primary padding" @click="filterRoomSchedule('begin')">
					<h2 class="display-flex">
						De: <input type="text" readonly="readonly" value="30/08/2022 19:00" data-roomschedulefilter="begin"/>
					</h2>
				</span>
			</div>
			<div class="display-flex justify-content-space-around margin-top">
				<span class="badge color-primary padding" @click="filterRoomSchedule('end')">
					<h2 class="display-flex">
						At√©: <input type="text" readonly="readonly" value="30/08/2022 22:40" data-roomschedulefilter="end"/>
					</h2>
				</span>
			</div>
			<div class="list simple-list">
				<ul class="roomScheduling">
					{{#if rooms}}
					{{#unless rooms.length}}
					<li class="item-content">
						<div class="item-inner">
							<div class="item-title">
								N√£o h√° salas dispon√≠veis neste per√≠odo üò•
								<div><small>Tente outro hor√°rio!</small></div>
							</div>
						</div>
					</li>
					{{else}}
					{{#each rooms}}
					<li class="item-content"
							@click="openRequestSchedule('{{this.room_id}}', '{{this.room}}', '{{this.block}}', '{{this.responsable}}')">
						<div class="item-inner">
							<div class="item-title-row">
								<div class="item-title">
									<div><b>{{this.room}}</b></div>
									<span class="badge color-orange">{{this.block}}</span>
								</div>
							</div>
							{{#if this.capacity}}
							<div class="item-text no-wrap">{{this.capacity}} Alunos</div>
							{{/if}}
						</div>
					</li>
					{{/each}}
					{{/unless}}
					{{else}}
					{{#each '123'}}
					<li class="item-content skeleton-text skeleton-effect-blink">
						<div class="item-inner">
							<div class="item-title-row">
								<div class="item-title">
									<div><b>____________</b></div>
									_______
								</div>
							</div>
							<div class="item-text no-wrap">__________</div>
						</div>
					</li>
					{{/each}}
					{{/if}}
				</ul>
			</div>
		</div>

		<div class="fab fab-right-bottom color-orange">
			<a href="#">
				<i class="icon f7-icons if-not-md">plus</i>
				<i class="icon f7-icons if-not-md">xmark</i>
				<i class="icon material-icons md-only">add</i>
				<i class="icon material-icons md-only">close</i>
			</a>
			<div class="fab-buttons fab-buttons-top">
				<a class="fab-label-button" href="/cu/room-scheduling/lessee/">
					<span><i class="icon f7-icons">calendar_badge_plus</i></span>
					<span class="fab-label">Agendamentos</span>
				</a>
				<a class="fab-label-button" href="/cu/room-scheduling/responsible/">
					<span><i class="icon f7-icons">chat_bubble_fill</i></span>
					<span class="fab-label">Solicita√ß√µes</span>
				</a>
			</div>
		</div>

		<div class="popup" id="cu-room-scheduling-schedule-popup">
			<div class="block no-margin-bottom">
				<a class="link popup-close" href="#">
					<i class="f7-icons">chevron_left</i>Voltar
				</a>
				<div class="display-flex flex-direction-column justify-content-flex-start">
					<div class="block no-margin-bottom">
						<h2><span id="schedule-room"></span> <span class="badge color-orange"><b id="schedule-block"></b></span></h2>
						<div>Respons√°vel pela Sala: <span id="schedule-responsable"></span></div>
						<hr class="margin-vertical">
					</div>
					<form id="cu-room-schedule">
						<div class="list no-hairlines no-margin">
							<ul>
								<li class="item-content item-input item-input-outline">
									<div class="item-inner">
										<div class="item-title item-floating-label">Data de In√≠cio</div>
										<div class="item-input-wrap">
											<input type="text" name="schedule-begin" disabled readonly/>
										</div>
									</div>
								</li>
								<li class="item-content item-input item-input-outline">
									<div class="item-inner">
										<div class="item-title item-floating-label">Data de Fim</div>
										<div class="item-input-wrap">
											<input type="text" name="schedule-end" disabled readonly/>
										</div>
									</div>
								</li>
								{{#if CCR}}
								<li class="item-content item-input item-input-outline">
									<div class="item-inner">
										<div class="item-title item-floating-label">CCR Vinculado</div>
										<div class="item-input-wrap">
											<select name="schedule-ccr">
												<option value=0></option>
												{{#each CCR}}
												<option value="{{this.id}}">{{this.name}}</option>
												{{/each}}
											</select>
										</div>
									</div>
								</li>
								{{/if}}
								<li class="item-content item-input item-input-outline">
									<div class="item-inner">
										<div class="item-title item-floating-label">Observa√ß√µes do Agendamento</div>
										<div class="item-input-wrap">
											<textarea name="schedule-description" id="" cols="30" rows="10"></textarea>
										</div>
									</div>
								</li>
							</ul>
						</div>
						<input type="hidden" name="schedule-room" id="schedule-room_id" value="">
					</form>

					<div class="block">
						<button class="button button-fill color-green margin-top" @click="requestRoomSchedule()">
							Enviar Solicita√ß√£o
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</template>
<style>
    .roomScheduling .item-content {
        line-height: normal;
        height: 100px;
    }

    /* Striped List */
    .roomScheduling .item-content:nth-child(even) {
        background-color: rgb(230, 230, 230);
    }

    input[data-roomschedulefilter] {
        margin-left: 5px;
        font-weight: bold;
        width: 150px;
    }
</style>
<script>
    export default {
        data: function () {
            return {
                CCR: null,
                rooms: null,
            }
        },
        on: {
            pageInit: function () {
                this.loadCCRs();
                this.loadEmptyRooms();
            },
        },
        methods: {
            filterRoomSchedule(filter) {
                let app = this.$app;

                let calendar = app.calendar.create({
                    inputEl: 'input[data-roomschedulefilter="' + filter + '"]',
                    dateFormat: 'dd/mm/yyyy HH::mm',
                    closeOnSelect: true,
                    backdrop: true,
                    timePicker: true,
                    on: {
                        close: this.loadEmptyRooms,
                        closed: function () {
                            calendar.destroy();
                        }
                    }
                });

                calendar.open();
            },
            openRequestSchedule(room_id, room, block, responsable) {
                let app = this.$app;

                app.form.fillFromData('#cu-room-schedule', {
                    'schedule-begin': app.$('input[data-roomschedulefilter="begin"]').val(),
                    'schedule-end': app.$('input[data-roomschedulefilter="end"]').val(),
                })

								app.$('#schedule-room_id').val(room_id)
								app.$('#schedule-room').text(room)
								app.$('#schedule-block').text(block)
								app.$('#schedule-responsable').text(responsable)

                let popup = app.popup.create({
                    swipeToClose: 'to-bottom',
                    closeByBackdropClick: true,
                    el: app.$$('#cu-room-scheduling-schedule-popup'),
                })
                popup.open();
            },
            requestRoomSchedule() {
                let app = this.$app;
                let formData = app.form.convertToData('#cu-room-schedule');

                app.dialog.preloader("Solicitando...");
                app.api.requestRoomSchedule(formData).then(data => {
                    app.dialog.close();
                    app.popup.close(app.$$('#cu-room-scheduling-schedule-popup'));
                    app.views.main.router.navigate('/cu/room-scheduling/lessee/');
                }).catch(e => {
                    app.dialog.close();
                    app.dialog.alert("Ocorreu um erro inesperado, tente novamente!");
                })
            },
            loadCCRs() {
                let app = this.$app;

                app.api.getCCRs().then(CCR => {
                    this.$setState({
                        CCR: CCR,
                    });
                }).catch(e => {
                    app.dialog.alert("Ocorreu um erro inesperado, tente novamente!");
                });
            },
            loadEmptyRooms() {
                let app = this.$app;

                this.$setState({
                    rooms: null,
                });

                let begin = app.$('input[data-roomschedulefilter="begin"]').val().replaceAll('/', ' ').split(' ');
                begin = begin[2] + '-' + begin[1] + '-' + begin[0] + 'T' + begin[3] + ':00';
                let end = app.$('input[data-roomschedulefilter="end"]').val().replaceAll('/', ' ').split(' ');
                end = end[2] + '-' + end[1] + '-' + end[0] + 'T' + end[3] + ':00';

                app.api.getEmptyRooms(begin, end).then(rooms => {
                    this.$setState({
                        rooms: rooms,
                    });
                }).catch(e => {
                    app.dialog.alert("Ocorreu um erro inesperado, tente novamente!");
                });
            }
        }
    }
</script>