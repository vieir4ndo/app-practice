<template>
	<div class="page" data-name="cu-room-scheduling-locator">

		<div class="navbar">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				<!-- Link to go back -->
				<div class="left">
					<a href="/" class="link back">
						<i class="icon icon-back"></i>
						<span class="if-not-md">Voltar</span>
					</a>
				</div>
				<div class="title">Agendamento de Salas</div>
			</div>
		</div>

		<div class="page-content">
			<div id="lottie" class="block display-flex align-items-center">
				<div id="lottie-text">
					<h2 class="no-margin">Agendamentos</h2>
				</div>
				<div>
					<lottie-player src="../static/lottie/cu-room-scheduling-locator.json" loop autoplay>
					</lottie-player>
				</div>
			</div>
			<div class="list simple-list">
				<ul class="roomScheduling">
					{{#if schedules}}
					{{#unless schedules.length}}
					<li class="item-content">
						<div class="item-inner">
							<div class="item-title">
								Voc√™ n√£o tem agendamento futuros üò•
								<div><small>Agende uma sala agora mesmo!</small></div>
							</div>
						</div>
					</li>
					{{else}}
					{{#each schedules}}
					<li class="item-content cu-room-scheduling-status-{{this.status}}" @click="detailsRoomSchedule({{this.id}})">
						<div class="item-inner">
							<div class="item-title-row">
								<div class="item-title">
									<div><b>{{this.room}}</b></div>
									{{#if this.ccr}}
									<span class="badge color-orange">{{this.ccr}}</span>
									{{/if}}
								</div>
							</div>
							<div class="item-text no-wrap">
								<div><b>{{this.begin}}</b></div>
							</div>
						</div>
					</li>
					{{/each}}
					{{/unless}}
					{{else}}
					{{#each '123'}}
					<li class="item-content skeleton-text skeleton-effect-blink">
						<div class="item-inner">
							<div class="item-title-row">
								<div class="item-title">
									<div><b>________</b></div>
									<span>_________</span>
								</div>
							</div>
							<div class="item-text no-wrap">
								<div><b>___________________</b></div>
							</div>
						</div>
					</li>
					{{/each}}
					{{/if}}
				</ul>
			</div>
		</div>

		<div class="fab fab-right-bottom color-orange">
			<a href="#">
				<i class="icon f7-icons if-not-md">plus</i>
				<i class="icon f7-icons if-not-md">xmark</i>
				<i class="icon material-icons md-only">add</i>
				<i class="icon material-icons md-only">close</i>
			</a>
			<div class="fab-buttons fab-buttons-top">
				<a class="fab-label-button" href="/cu/room-scheduling/responsible/">
					<span><i class="icon f7-icons">chat_bubble_fill</i></span>
					<span class="fab-label">Solicita√ß√µes</span>
				</a>
				<a class="fab-label-button" href="/cu/room-scheduling/schedule/">
					<span><i class="icon material-icons">add</i></span>
					<span class="fab-label">Novo Agendamento</span>
				</a>
			</div>
		</div>

		<div class="popup display-flex flex-direction-column-reverse" id="cu-room-scheduling-locator-popup"
				 style="background: none;">
			<div class="block bg-white padding no-margin display-flex flex-direction-column justify-content-space-between"
					 style="height: 60vh; background-color: white;">
				{{#if schedule}}
				<div class="block no-margin">
					<h2>{{schedule.room}}</h2>
					<div>Respons√°vel: {{schedule.responsable}}</div>
					<div>Status do Agendamento: <b>{{schedule.statusDescription}}</b></div>
					<hr class="margin-vertical">
					<div class="text-align-right">In√≠cio da Reserva: <b>{{schedule.begin}}</b></div>
					<div class="text-align-right">Fim da Reserva: <b>{{schedule.end}}</b></div>
					{{#if schedule.ccr}}
					<div class="margin-top padding-top">CCR vinculado: <b>{{schedule.ccr}}</b></div>
					{{/if}}
					{{#if schedule.description}}
					<div class="margin-top padding-top">Observa√ß√µes:</div>
					<textarea rows="4" style="width: 100%;">{{schedule.description}}</textarea>
					{{/if}}
				</div>
				{{#if schedule.status}}
				<div class="block no-margin">
					<div>Observa√ß√µes da Aprova√ß√£o:</div>
					<textarea rows="4" style="width: 100%;">{{schedule.observation}}</textarea>
				</div>
				{{else}}
				<button class="align-self-flex-end button button-fill color-red margin-top"
								@click="deleteRoomSchedule({{schedule.id}})">
					Cancelar Agendamento
				</button>
				{{/if}}
			</div>
			{{else}}
			<div class="block no-margin skeleton-text skeleton-effect-blink">
				<h2>___________</h2>
				<div>___________ ____ ____: __________ __ _________</div>
				<div>______ __ ___________: <b>_____________</b></div>
				<hr class="margin-vertical">
				<div class="text-align-right">______ __ _______: <b>__________ ________</b></div>
				<div class="text-align-right">___ __ _______: <b>__________ ________</b></div>
				<div class="margin-top padding-vertical">_____________: <b>_______</b></div>
			</div>
		</div>
		{{/if}}
	</div>
	</div>
</template>
<style>
    .roomScheduling .item-content {
        line-height: normal;
        height: 100px;
    }

    /* Striped List */
    .roomScheduling .item-content:nth-child(even) {
        background-color: rgb(230, 230, 230);
    }

    .cu-room-scheduling-filter input {
        width: 100px;
        margin-left: 5px;
        font-weight: bold;
    }

    .cu-room-scheduling-status-0 {
        border-left: solid 10px #FCAE17
    }

    .cu-room-scheduling-status-1 {
        border-left: solid 10px green;
    }

    .cu-room-scheduling-status-2 {
        border-left: solid 10px rgb(218, 36, 36);
    }

</style>
<script>
    export default {
        data: function () {
            return {
                schedules: null,
                schedule: null
            }
        },
        on: {
            pageInit: function () {
                this.loadRoomSchedules();
            }
        },
        methods: {
            detailsRoomSchedule(id) {
                let app = this.$app;

                app.api.getRoomSchedule(id).then(schedule => {
                    let statusList = ['Aguardando', 'Aprovado', 'Negado']
                    schedule.statusDescription = statusList[schedule.status]
                    this.$setState({
                        schedule: schedule
                    });
                })

                let popup = app.popup.create({
                    swipeToClose: 'to-bottom',
                    closeByBackdropClick: true,
                    el: app.$$('#cu-room-scheduling-locator-popup'),
                    on: {
                        closed: this.clearReserveFields
                    }
                })
                popup.open();
            },
            loadRoomSchedules() {
                let app = this.$app;
                this.$setState({
                    schedules: null,
                });
                app.api.getRoomSchedules().then(schedules => {
                    this.$setState({
                        schedules: schedules,
                    });
                })
            },
            deleteRoomSchedule(id) {
                let app = this.$app;

                app.dialog.preloader("Cancelando...");
                app.api.deleteRoomSchedule(id).then(() => {
                    app.dialog.close();
                    app.popup.close(app.$$('#cu-room-scheduling-locator-popup'));
                    this.loadRoomSchedules();
                }).catch(e => {
                    app.dialog.close();
                    app.dialog.alert("Ocorreu um erro inesperado, tente novamente!");
                })
            },
            clearReserveFields() {
                this.$setState({
                    schedule: null
                });
            }
        }
    }
</script>